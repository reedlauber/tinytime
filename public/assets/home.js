(function(a){a.Title=function(e){var c={},b=$.extend({id:"title",target:"#content"},e),d;var f,h;function g(j){var i=h.val();if(!i){i="Untitled"}if(i!=f.text()){a.Data.save("/"+d.token,{name:i},function(){f.text(i);j()},function(){j()})}else{j()}}c.init=function(i){d=i;f=$("#"+b.id+"-label",b.target);h=$("#"+b.id+"-input",b.target);f.click(function(){f.hide();h.show().focus()});h.blur(function(){g(function(){h.hide();f.show()})});return c};return c}})(TinyTime);(function(a){a.NewEntry=function(q){var l={},o=$.extend({id:"newentry",target:"#content",fields:[{id:"newentry-time",prop:"minutes",required:true},{id:"newentry-desc",prop:"desc",required:true,submit:true},{id:"newentry-tags",prop:"tags",submit:true}]},q),f;var m=/^[\d\.]+$/g,j=/^[0-9]{1,2}:[0-9]{2}$/,k=/[0-9\.]d/,d=/[0-9\.]h/,g=/[0-9\.]m/;function c(w){var t=0,u,s,r,v;if(m.test(w)){t=Math.floor(parseFloat(w))}else{if(j.test(w)){u=w.split(":");s=parseInt(u[0]);r=parseInt(u[1]);if(!$.isNaN(s)&&!$.isNaN(r)){t+=(s*60);t+=r}}else{u=w.split(" ");$.each(u,function(y,x){if(k.test(x)){v=parseFloat(x.replace("d",""));t+=(v*24*60)}else{if(d.test(x)){s=parseFloat(x.replace("h",""));t+=(s*60)}else{if(g.test(x)){r=Math.floor(parseFloat(x.replace("m","")));t+=r}}}})}}return t}function e(s){if(s.required){var r=!!$("#"+s.id).val();if(!r){$("#"+s.id).parent().addClass("error")}return r}return true}function b(){$("input","#"+o.id).val("");$(".tt-newentry-workdate-label").html("Today");$("#newentry-workdate input").val($("#newentry-workdate").attr("data-date"));$("#"+o.fields[0].id).focus()}function n(){$(".error","#"+o.id).removeClass("error");var s=true,r={token:f.token,work_date:$("#newentry-workdate").attr("data-date")};$.each(o.fields,function(t,u){if(e(u)){r[u.prop]=$("#"+u.id).val()}else{s=false}});if(s){r.minutes=c(r.minutes);a.Data.save("/"+f.token+"/entries",r,function(t){b();$(a).trigger("entry-created",[t])})}}function h(){$.each(o.fields,function(r,s){if(s.submit){$("#"+s.id).keyup(function(t){if(t.which===13){$("#"+o.id+"-btn").click()}})}})}function p(t){var s=Date.parse(t),r={date:Date.today().toString(a.dateFormat),label:"Today"};if(s){s=s.clearTime();if(s<=Date.today()){r.date=s.toString(a.dateFormat);r.label=a.Util.recentDateLabel(s)}}return r}function i(){$("#"+o.id+"-btn").click(function(){try{n()}catch(s){a.log(s)}return false});var r=$(".tt-newentry-workdate-label").click(function(){$(this).hide();$("#newentry-workdate input").show()});$("#newentry-workdate input").blur(function(){var t=$(this).val();var s=p(t);if(s){r.html(s.label);$("#newentry-workdate").attr("data-date",s.date)}$(this).hide();r.show()});$(a).bind("timer-stopped",function(u,x){var w=Math.floor(x/(60*60));x-=w*60*60;var s=Math.round(x/60);var v="";if(w){v=w+"h"}if(s){v+=w?" ":"";v+=s+"m"}$("#"+o.fields[0].id).val(v);if(v){$("#"+o.fields[1].id).focus()}})}l.init=function(r){f=r;b();i();return l};return l}})(TinyTime);(function(a){a.Entries=function(r){var l={},p=$.extend({id:"entries",target:"#content"},r),d,k=[],n={},e=[],o=0;var q,c;var h=['<tr data-id="{{id}}">','<td class="tt-entry-time span3">{{time}}</td>','<td class="tt-entry-desc">','{{#tags}}<span class="label notice">{{tags}}</span>{{/tags}}',"{{description}}","</td>",'<td><a href="javascript:void(0)" class="close">&times;</a></td>',"</tr>"].join("");var i=['<section class="tt-entry-group" data-date="{{work_date}}">',"<h2>{{label}}</h2>",'<table class="tt-entries-table zebra-striped">',"{{#entries}}",h,"{{/entries}}","</table>","<footer>{{total}}</footer>","</section>"].join("");function j(){var t=Date.today().toString(a.dateFormat);var s=[{work_date:t,entries:[]}];n[t]=0;$.each(e,function(v,w){var x,u;if(w.work_date in n){u=n[w.work_date];x=s[u]}else{u=s.length;n[w.work_date]=u;x={work_date:w.work_date,entries:[]};s.push(x)}x.entries.push(w)});return s}function m(){$(".tt-summary-time").html(a.Util.relativeTime(o))}function b(){q.empty();o=0;$.each(k,function(t,u){u.minutes=0;$.each(u.entries,function(v,w){w.time=a.Util.relativeTime(w.minutes);u.minutes+=w.minutes});o+=u.minutes;u.label=a.Util.recentDateLabel(u.work_date,true);u.total=a.Util.relativeTime(u.minutes);var s=a.template(i,u);q.append(s)});m()}function g(t,s,u){t.fadeOut(function(){t.remove();o-=s.minutes;m();var w=k[n[s.work_date]];var v=-1;$.each(w.entries,function(x,y){if(y.id===s.id){v=x;return false}});if(v>-1){w.entries.splice(v,1)}if(!w.entries.length&&w.label!=="Today"){$(".tt-entry-group[data-date="+w.work_date+"]").remove();k.splice(n[s.work_date]);n={};$.each(k,function(x,y){n[y.work_date]=x})}else{w.minutes-=s.minutes;w.total=a.Util.relativeTime(w.minutes);$(".tt-entry-group[data-date="+w.work_date+"] footer").html(w.total)}if(u>-1){e.splice(u,1)}})}function f(){$(".tt-entries-table").live("click",function(t){if($(t.target).hasClass("close")){var s=$(t.target).parents("tr");var w=parseInt(s.attr("data-id"),10);var u=-1;$.each(e,function(x,y){if(y.id===w){u=x;return false}});var v=e[u];if(v){a.Data.del("/"+d.token+"/entries/"+w,function(x){if(x.success){g(s,v,u)}else{alert(x.message)}})}}});$(a).bind("entry-created",function(z,w){w.time=a.Util.relativeTime(w.minutes);o+=w.minutes;if(w.work_date in n){var y=k[n[w.work_date]];y.minutes+=w.minutes;y.total=a.Util.relativeTime(y.minutes);var x=$("section[data-date="+w.work_date+"]"),A=$("table",x),u=$("footer",x);var t=a.template(h,w);$(t).appendTo(A).hide().fadeIn();u.html(y.total)}else{n[w.work_date]=k.length;var v=a.Util.recentDateLabel(w.work_date,true);var y={work_date:w.work_date,entries:[w],label:v,minutes:w.minutes};y.total=a.Util.relativeTime(y.minutes);k.push(y);var s=a.template(i,y);q.append(s)}m();e.push(w)})}l.init=function(s){d=s;q=$("#"+p.id,p.target);c=$("#summary",p.target);a.Data.get("/"+d.token+"/entries",function(t){e=t;k=j();b()});f();return l};return l}})(TinyTime);(function(a){a.Timer=function(d){var f=a.Component({id:"timer"},d);var c,j,r,n,p,q;function e(t){if(t.toString().length<2){return"0"+t}return t.toString()}function o(x,u,w){var v="";if(x){v+=e(x)+":"}if(u){v+=e(u)+":"}v+=e(w);return v}var b,m,i=0,k;function g(){m=new Date();b=setInterval(function(){var w=new Date()-m+i;w=Math.floor(w/1000);var v=Math.floor(w/(60*60));w-=(v*60*60);var t=Math.floor(w/60);w-=(t*60);var u=w;j.html(o(v,t,u))},500);k=true}function h(){clearInterval(b);i=new Date()-m+i;k=false}function s(){i=0;j.html("00")}function l(){n.click(function(){j.show();n.hide();p.show();q.show();c.addClass("active");s();g()});p.click(function(){if(k){h();p.text("Run")}else{g();p.text("Pause")}});q.click(function(){j.html('<span class="tt-timer-time-last">last</span> '+j.html());n.show();p.hide().text("Pause");q.hide();c.removeClass("active");h();$(a).trigger("timer-stopped",[Math.floor(i/1000)])})}f.oninit=function(){c=$('<div id="'+f.options.id+'" class="tt-timer tt-shadow tt-requireinstance" />').appendTo(f.options.target).append("<h5>Timer</h5>");j=$('<div class="tt-timer-time">00</div>').appendTo(c);r=$('<div class="tt-timer-btns" />').appendTo(c);n=$('<span class="btn success">Start</span>').appendTo(r);p=$('<span class="btn info">Pause</span>').appendTo(r).hide();q=$('<span class="btn danger">Stop</span>').appendTo(r).hide();l()};return f.pub}})(TinyTime);