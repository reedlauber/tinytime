(function(a){a.Timer=function(b){function j(a){return a.toString().length<2?"0"+a:a.toString()}function k(a,b,c){var d="";return a&&(d+=j(a)+":"),b&&(d+=j(b)+":"),d+=j(c),d}function p(){m=new Date,l=setInterval(function(){var a=new Date-m+n;a=Math.floor(a/1e3);var b=Math.floor(a/3600);a-=b*60*60;var c=Math.floor(a/60);a-=c*60;var d=a;e.html(k(b,c,d))},500),o=!0}function q(){clearInterval(l),n=new Date-m+n,o=!1}function r(){n=0,e.html("00")}function s(){g.click(function(){e.show(),g.hide(),h.show(),i.show(),d.addClass("active"),r(),p()}),h.click(function(){o?(q(),h.text("Run")):(p(),h.text("Pause"))}),i.click(function(){e.html('<span class="tt-expand-reveal-inline tt-timer-time-last">last</span> '+e.html()),g.show(),h.hide().text("Pause"),i.hide(),d.removeClass("active"),q(),$(a).trigger("timer-stopped",[Math.floor(n/1e3)])})}var c=a.Component({id:"timer"},b),d,e,f,g,h,i,l,m,n=0,o;return c.oninit=function(){d=$('<div id="'+c.options.id+'" class="tt-shadow tt-expand tt-timer tt-requireinstance" />').appendTo(c.options.target).append("<h5>Timer</h5>"),e=$('<div class="tt-timer-time">00</div>').appendTo(d),f=$('<div class="tt-expand-reveal tt-timer-btns" />').appendTo(d),g=$('<span class="btn success">Start</span>').appendTo(f),h=$('<span class="btn info">Pause</span>').appendTo(f).hide(),i=$('<span class="btn danger">Stop</span>').appendTo(f).hide(),s()},c.pub}})(TinyTime),function(a){a.Title=function(b){function h(b){var c=g.val();c||(c="Untitled"),c!=f.text()?a.Data.save("",{token:e.token,name:c},function(a){f.text(c),b(),window.location.href="/"+e.username+"/"+a.slug+"/"+e.token},function(){b()}):b()}var c={},d=$.extend({id:"title",target:"#content"},b),e,f,g;return c.init=function(a){return e=a,f=$("#"+d.id+"-label",d.target),g=$("#"+d.id+"-input",d.target),f.click(function(){f.hide(),g.show().focus()}),g.blur(function(){h(function(){g.hide(),f.show()})}),c},c}}(TinyTime),function(a){a.NewEntry=function(b){function k(a){var b=0,c,d,e,k;return f.test(a)?b=Math.floor(parseFloat(a)):g.test(a)?(c=a.split(":"),d=parseInt(c[0]),e=parseInt(c[1]),!$.isNaN(d)&&!$.isNaN(e)&&(b+=d*60,b+=e)):(c=a.split(" "),$.each(c,function(a,c){h.test(c)?(k=parseFloat(c.replace("d","")),b+=k*24*60):i.test(c)?(d=parseFloat(c.replace("h","")),b+=d*60):j.test(c)&&(e=Math.floor(parseFloat(c.replace("m",""))),b+=e)})),b}function l(a){if(a.required){var b=!!$("#"+a.id).val();return b||$("#"+a.id).parent().addClass("error"),b}return!0}function m(){$("#"+d.id+"-time, #"+d.id+"-desc").val(""),$("#newentry-workdate input").val($("#newentry-workdate").attr("data-date")),$("#"+d.fields[0].id).focus()}function n(){$(".error","#"+d.id).removeClass("error");var b=!0,c={token:e.token,work_date:$("#newentry-workdate").attr("data-date")};$.each(d.fields,function(a,d){l(d)?c[d.prop]=$("#"+d.id).val():b=!1}),b&&(c.minutes=k(c.minutes),a.Data.add("/entries",c,function(b){m(),$(a).trigger("entry-created",[b])}))}function o(){$.each(d.fields,function(a,b){b.submit&&$("#"+b.id).keyup(function(a){a.which===13&&$("#"+d.id+"-btn").click()})})}function p(b){var c=Date.parse(b),d={date:Date.today().toString(a.dateFormat),label:"Today"};return c&&(c=c.clearTime(),c<=Date.today()&&(d.date=c.toString(a.dateFormat),d.label=a.Util.recentDateLabel(c))),d}function q(){$("#"+d.id+"-btn").click(function(){try{n()}catch(b){a.log(b)}return!1});var b=$(".tt-newentry-workdate-label").click(function(){$(this).hide(),$("#newentry-workdate input").show()});$("#newentry-workdate input").blur(function(){var a=$(this).val(),c=p(a);c&&(b.html(c.label),$("#newentry-workdate").attr("data-date",c.date)),$(this).hide(),b.show()}),$(a).bind("timer-stopped",function(a,b){var c=Math.floor(b/3600);b-=c*60*60;var e=Math.round(b/60),f="";c&&(f=c+"h"),e&&(f+=c?" ":"",f+=e+"m"),$("#"+d.fields[0].id).val(f),f&&$("#"+d.fields[1].id).focus()})}var c={},d=$.extend({id:"newentry",target:"#content",fields:[{id:"newentry-time",prop:"minutes",required:!0},{id:"newentry-desc",prop:"desc",required:!0,submit:!0},{id:"newentry-tags",prop:"tags",submit:!0}]},b),e,f=/^[\d\.]+$/g,g=/^[0-9]{1,2}:[0-9]{2}$/,h=/[0-9\.]d/,i=/[0-9\.]h/,j=/[0-9\.]m/;return c.init=function(a){return e=a,m(),q(),c},c}}(TinyTime),function(a){a.Entries=function(b){function o(){var b=Date.today().toString(a.dateFormat),c=[{work_date:b,entries:[]}];return g[b]=0,$.each(h,function(a,b){var d,e;b.work_date in g?(e=g[b.work_date],d=c[e]):(e=c.length,g[b.work_date]=e,d={work_date:b.work_date,entries:[]},c.push(d)),d.entries.push(b)}),c}function p(){var b=a.Util.relativeTime(j);$(".tt-summary-time").html(b)}function q(){k.empty(),j=0,i=0,$.each(f,function(b,c){c.minutes=0,$.each(c.entries,function(b,d){d.time=a.Util.relativeTime(d.minutes),c.minutes+=d.minutes,j+=d.minutes,d.invoice_id||(i+=d.minutes)}),c.label=a.Util.recentDateLabel(c.work_date,!0),c.total=a.Util.relativeTime(c.minutes);var d=a.template(n,c);k.append(d)}),p()}function r(b,c,d){b.fadeOut(function(){b.remove(),j-=c.minutes,p();var e=f[g[c.work_date]],i=-1;$.each(e.entries,function(a,b){if(b.id===c.id)return i=a,!1}),i>-1&&e.entries.splice(i,1),!e.entries.length&&e.label!=="Today"?($(".tt-entry-group[data-date="+e.work_date+"]").remove(),f.splice(g[c.work_date]),g={},$.each(f,function(a,b){g[b.work_date]=a})):(e.minutes-=c.minutes,e.total=a.Util.relativeTime(e.minutes),$(".tt-entry-group[data-date="+e.work_date+"] footer").html(e.total)),d>-1&&h.splice(d,1)})}function s(){$(".tt-entries-table").live("click",function(b){if($(b.target).hasClass("close")){var c=$(b.target).parents("tr"),d=parseInt(c.attr("data-id"),10),f=-1;$.each(h,function(a,b){if(b.id===d)return f=a,!1});var g=h[f];g&&a.Data.del("/entries/"+d,{token:e.token},function(a){a.success?r(c,g,f):alert(a.message)})}}),$(a).bind("entry-created",function(b,c){c.time=a.Util.relativeTime(c.minutes),j+=c.minutes;if(c.work_date in g){var d=f[g[c.work_date]];d.minutes+=c.minutes,d.total=a.Util.relativeTime(d.minutes);var e=$("section[data-date="+c.work_date+"]"),i=$("table",e),l=$("footer",e),o=a.template(m,c);$(o).prependTo(i).hide().fadeIn(),l.html(d.total)}else{g[c.work_date]=f.length;var q=a.Util.recentDateLabel(c.work_date,!0),d={work_date:c.work_date,entries:[c],label:q,minutes:c.minutes};d.total=a.Util.relativeTime(d.minutes),f.push(d);var r=a.template(n,d);k.append(r)}p(),h.push(c)})}var c={},d=$.extend({id:"entries",target:"#content"},b),e,f=[],g={},h=[],i=0,j=0,k,l,m=['<tr data-id="{{id}}">','<td class="tt-entry-time span3">{{time}}</td>','<td class="tt-entry-desc">','{{#tags}}<span class="label notice">{{tags}}</span>{{/tags}}',"{{description}}","</td>",'<td class="tt-entry-last">','{{#invoice_id}}<span class="label">Invoiced</span>{{/invoice_id}}','{{^invoice_id}}<a href="javascript:void(0)" class="tt-entry-del close">&times;</a>{{/invoice_id}}',"</td>","</tr>"].join(""),n=['<section class="tt-entry-group" data-date="{{work_date}}">',"<h2>{{label}}</h2>",'<table class="tt-entries-table zebra-striped">',"{{#entries}}",m,"{{/entries}}","</table>","<footer>{{total}}</footer>","</section>"].join("");return c.init=function(b){return e=b,k=$("#"+d.id,d.target),l=$("#summary",d.target),a.Data.get("/entries",function(b){h=b,a.Util.groupEntries(h,function(a,b){f=a,g=b,q()},!0)}),s(),c},c}}(TinyTime);